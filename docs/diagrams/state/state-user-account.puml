@startuml state-user-account
title State Diagram - Trạng thái tài khoản người dùng (User Account)
skinparam linetype ortho
skinparam nodesep 80
skinparam ranksep 100

[*] --> Registered : Đăng ký tài khoản

state Registered {
  Registered : Tài khoản mới tạo
  Registered : Email chưa xác thực
  Registered : KYC chưa thực hiện
  Registered : Chức năng bị giới hạn
}

Registered --> EmailVerified : Xác thực email thành công\n(click link trong email)

state EmailVerified {
  EmailVerified : Email đã xác thực
  EmailVerified : Có thể đăng nhập đầy đủ
  EmailVerified : KYC vẫn pending
  EmailVerified : Một số tính năng bị hạn chế
}

EmailVerified --> KYCPending : Gửi giấy tờ KYC\n(CMND, bằng lái, selfie)

state KYCPending {
  KYCPending : Đã gửi giấy tờ
  KYCPending : Chờ Admin duyệt
  KYCPending : Processing time: 1-3 ngày
}

KYCPending --> KYCApproved : Admin phê duyệt KYC
KYCPending --> KYCRejected : Admin từ chối KYC\n(giấy tờ không hợp lệ)
KYCPending --> EmailVerified : User hủy yêu cầu KYC

state KYCRejected {
  KYCRejected : KYC bị từ chối
  KYCRejected : Có lý do từ chối
  KYCRejected : Có thể nộp lại
}

KYCRejected --> KYCPending : Gửi lại giấy tờ\n(đã bổ sung/sửa)

state KYCApproved {
  KYCApproved : KYC đã được phê duyệt
  KYCApproved : trust_level tăng
  KYCApproved : Mở khóa tất cả tính năng:
  KYCApproved : ✓ Tạo/join groups
  KYCApproved : ✓ Booking vehicles
  KYCApproved : ✓ Ký hợp đồng
  KYCApproved : ✓ Thanh toán
}

KYCApproved --> Active : Tài khoản hoạt động bình thường

state Active {
  Active : Tài khoản active
  Active : Đầy đủ quyền truy cập
  Active : Có thể sử dụng tất cả tính năng
  Active : Good standing
}

Active --> Suspended : Vi phạm policy\nhoặc Admin tạm khóa

state Suspended {
  state "Warning" as S_Warning
  state "Temporary Suspended" as S_Temp
  state "Permanent Suspended" as S_Perm
  
  [*] --> S_Warning : Vi phạm nhẹ lần đầu
  
  S_Warning : Nhận cảnh báo
  S_Warning : Ghi nhận vào lịch sử
  S_Warning : Có thời gian khắc phục
  S_Warning : Giảm trust_score
  
  S_Warning --> S_Temp : Tiếp tục vi phạm\nhoặc vi phạm nghiêm trọng
  S_Warning --> [*] : Khắc phục vi phạm\n(sau 30 ngày)
  
  S_Temp : Khóa tạm thời (7-30 ngày)
  S_Temp : Không thể đăng nhập
  S_Temp : Không thể booking
  S_Temp : Phải hoàn thành actions
  S_Temp : (thanh toán nợ, giải quyết tranh chấp)
  
  S_Temp --> S_Perm : Vi phạm nghiêm trọng\nhoặc không khắc phục
  S_Temp --> [*] : Hoàn thành khắc phục\n+ Admin review
  
  S_Perm : Khóa vĩnh viễn
  S_Perm : Không thể khôi phục
  S_Perm : Data được lưu trữ
  S_Perm : Blacklist email/phone
}

Suspended --> Active : Admin mở khóa\n(sau khi khắc phục)
Suspended --> Locked : Vi phạm nghiêm trọng\nhoặc gian lận

Active --> Locked : Phát hiện gian lận\nhoặc hành vi đáng ngờ

state Locked {
  Locked : Tài khoản bị khóa
  Locked : Yêu cầu xác minh danh tính
  Locked : Không thể đăng nhập
  Locked : Đang điều tra
}

Locked --> Active : Xác minh thành công\n+ Không có vi phạm
Locked --> Suspended : Phát hiện vi phạm\n(chuyển sang xử lý)

Active --> Inactive : Không đăng nhập\nquá 6 tháng

state Inactive {
  Inactive : Không hoạt động lâu
  Inactive : Data được lưu trữ
  Inactive : Có thể kích hoạt lại
  Inactive : Nhận email reminder
}

Inactive --> Active : Đăng nhập lại\n+ Xác nhận email
Inactive --> [*] : Tự xóa tài khoản\nhoặc hệ thống archive (> 2 năm)

Active --> [*] : User yêu cầu xóa tài khoản\n(GDPR compliance)

note right of Registered
  Hạn chế:
  - Không thể tạo/join group
  - Không thể booking
  - Chỉ xem thông tin
end note

note right of EmailVerified
  Hạn chế:
  - Join group: OK
  - Tạo group: Cần KYC
  - Booking: Cần KYC
  - Max booking/day: 1
end note

note right of KYCApproved
  Full features:
  - Create groups
  - Unlimited bookings
  - Ký hợp đồng
  - Cao trust_score
  - Ưu tiên hỗ trợ
end note

note right of Suspended
  Lý do khóa:
  1. Quá hạn thanh toán > 30 ngày
  2. Vi phạm hợp đồng
  3. Hư hỏng xe cố ý
  4. Gian lận booking
  5. Hành vi không phù hợp
end note

note bottom of Locked
  Triggers:
  - Nhiều đăng nhập thất bại
  - IP đáng ngờ
  - Thay đổi info bất thường
  - Report từ members khác
  - Payment fraud detected
end note

@enduml
